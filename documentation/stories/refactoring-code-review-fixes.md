# Story: Code Review Fixes

## Summary

Fix issues found during code review. Organized into 6 phases by dependency order.

---

## Phase 1: Domain Layer Cleanups

### 1.1 H3 — Fingerprint validation

**Problem:** `NewFingerprint` accepts any non-empty string. Used as Redis key suffix (`kmbridge:alert:{value}`) and in Keep UI URLs. Allows special characters, whitespace, extremely long strings.

**Research:** Keep fingerprints are opaque strings generated by Keep's alerting engine. Based on test examples (`fp-12345`, `abc123`, `xyz789`) and Keep source code patterns, fingerprints are typically SHA-256 hex digests or short alphanumeric identifiers.

**Fix:**
- `domain/alert/fingerprint.go`: Add validation in `NewFingerprint`:
  - Max length: 512 characters
  - Allowed characters: `[a-zA-Z0-9._-]` (alphanumeric, dot, underscore, hyphen)
  - Compile regex as package-level `var`
- Update `domain/alert/errors.go` if new error types needed
- Update tests

### 1.2 L19 — Remove unused Color value object

**Problem:** `domain/post/color.go` defines `Color` type that is never used anywhere.

**Fix:** Delete `domain/post/color.go`.

### 1.3 L27 — Remove JSON tags from domain types

**Problem:** `Attachment`, `AttachmentField`, `Button`, `ButtonIntegration` in `domain/post/` carry `json:"..."` tags. This couples domain to Mattermost wire format.

**Fix:**
- `domain/post/attachment.go`: Remove all `json:"..."` tags from `Attachment` and `AttachmentField`
- `domain/post/button.go`: Remove all `json:"..."` tags from `Button` and `ButtonIntegration`
- `infrastructure/mattermost/client.go`: Add private wire types (`mattermostAttachment`, `mattermostField`, `mattermostButton`, `mattermostButtonIntegration`) with JSON tags. Add conversion function `toWireAttachment(post.Attachment) mattermostAttachment`
- Use wire types in `CreatePost` and `UpdatePost` serialization
- Update tests

---

## Phase 2: DTO & Boundary Fixes

### 2.1 M16 — Callback output DTO

**Problem:** `HandleCallbackUseCase.Execute` returns `*post.Attachment` (domain type) directly to the handler. Violates CA boundary.

**Fix:**
- Create `application/dto/callback_output.go`:
```go
type CallbackOutput struct {
    Attachment AttachmentDTO `json:"attachment"`
    Ephemeral  string        `json:"ephemeral_text"`
}

type AttachmentDTO struct {
    Color      string              `json:"color,omitempty"`
    Title      string              `json:"title,omitempty"`
    TitleLink  string              `json:"title_link,omitempty"`
    Text       string              `json:"text,omitempty"`
    Fields     []AttachmentFieldDTO `json:"fields,omitempty"`
    Actions    []ButtonDTO          `json:"actions,omitempty"`
    Footer     string              `json:"footer,omitempty"`
    FooterIcon string              `json:"footer_icon,omitempty"`
}

type AttachmentFieldDTO struct {
    Title string `json:"title"`
    Value string `json:"value"`
    Short bool   `json:"short"`
}

type ButtonDTO struct {
    ID          string              `json:"id"`
    Name        string              `json:"name"`
    Integration ButtonIntegrationDTO `json:"integration"`
}

type ButtonIntegrationDTO struct {
    URL     string            `json:"url"`
    Context map[string]string `json:"context"`
}
```
- Add `dto.AttachmentDTOFromDomain(post.Attachment) AttachmentDTO` mapping function in same file
- `application/usecase/handle_callback.go`: Change return to `(*dto.CallbackOutput, error)`. Build DTO from domain attachment inside use case.
- `interface/http/handler/callback_handler.go`: Update `CallbackHandler` interface and handler to use `dto.CallbackOutput`. Build HTTP response from DTO.
- `application/port/message_builder.go`: Keep returning `post.Attachment` (domain type) — this is correct, builder is invoked within use case.
- Update tests

### 2.2 M13 — DTO field length validation

**Problem:** No length limits on DTO fields within 1MB body limit.

**Fix:**
- `application/dto/keep_alert.go`: Add `binding` tags:
```go
type KeepAlertInput struct {
    ID          string `json:"id"          binding:"max=256"`
    Name        string `json:"name"        binding:"required,max=512"`
    Status      string `json:"status"      binding:"required,max=64"`
    Severity    string `json:"severity"    binding:"required,max=64"`
    Source      string `json:"source"      binding:"max=512"`
    Fingerprint string `json:"fingerprint" binding:"required,max=512"`
    Description string `json:"description" binding:"max=4096"`
    Labels      string `json:"labels"      binding:"max=65536"`
}
```
- This also fixes **L22** — `required` tags ensure Gin returns 400 (not 500) for missing fields

### 2.3 L22 — Required field validation (covered by 2.2)

Gin's `binding:"required"` returns 400 for missing required fields. No separate fix needed.

---

## Phase 3: Channel ID Migration

### 3.1 M12 — Switch from channel names to channel IDs

**Problem:** Config specifies channel names, which are resolved to IDs via Mattermost API. Cache never invalidates. Requires `MATTERMOST_TEAM`.

**Fix — Config layer:**
- `infrastructure/config/file_config.go`:
  - `RoutingRule.Channel` now stores channel ID (rename field to `ChannelID`)
  - `ChannelsConfig.Default` now stores channel ID
  - `ChannelForSeverity` returns channel ID directly
  - YAML config changes: `channel: "channel-id-here"` (document as channel ID)
- `infrastructure/config/config.go`:
  - Remove `Team` from `MattermostConfig`
  - Remove `MATTERMOST_TEAM` from validation

**Fix — Port layer:**
- `application/port/mattermost.go`: Remove `GetChannelByName` method. Interface becomes:
```go
type MattermostClient interface {
    CreatePost(ctx context.Context, channelID string, attachment post.Attachment) (string, error)
    UpdatePost(ctx context.Context, postID string, attachment post.Attachment) error
    GetUser(ctx context.Context, userID string) (string, error)
}
```
- `application/port/channel_resolver.go`: Rename method to clarify it returns ID:
```go
type ChannelResolver interface {
    ChannelIDForSeverity(severity string) string
}
```

**Fix — Use case layer:**
- `application/usecase/handle_alert.go`:
  - Remove `teamName` field from `HandleAlertUseCase`
  - Remove `teamName` param from `NewHandleAlertUseCase`
  - `handleFiring`: Replace `GetChannelByName(ctx, teamName, channelName)` with direct `channelResolver.ChannelIDForSeverity(severity)` call
  - Rename local var `channelName` → `channelID`

**Fix — Infrastructure layer:**
- `infrastructure/mattermost/client.go`:
  - Remove `channels map[string]string`, `mu sync.RWMutex`
  - Remove `GetChannelByName` method
  - Remove `ResolveChannels` method

**Fix — main.go:**
- Remove `collectChannelNames`, channel pre-resolution logic
- Remove `cfg.Mattermost.Team` parameter from use case constructor

**Update all tests.**

---

## Phase 4: Infrastructure Improvements

### 4.1 M11 — HTTP transport tuning

**Problem:** Default `MaxIdleConnsPerHost=2` causes TCP/TLS churn under burst load.

**Fix:**
- `infrastructure/mattermost/client.go` `NewClient`:
```go
httpClient: &http.Client{
    Timeout: 30 * time.Second,
    Transport: &http.Transport{
        MaxIdleConns:        20,
        MaxIdleConnsPerHost: 10,
        IdleConnTimeout:     90 * time.Second,
    },
},
```
- `infrastructure/keep/client.go` `NewClient`: Same transport config.

### 4.2 M14 — Pre-register metrics

**Problem:** `GetOrCreateCounter`/`GetOrCreateHistogram` on every request causes map lookup + hash.

**Fix:** Pre-register metrics as package-level vars or struct fields. Example for `infrastructure/valkey/post_repository.go`:
```go
var (
    redisSetOK    = metrics.NewCounter(`redis_operations_total{operation="set",status="ok"}`)
    redisSetErr   = metrics.NewCounter(`redis_operations_total{operation="set",status="error"}`)
    redisSetDur   = metrics.NewHistogram(`redis_operation_duration_seconds{operation="set"}`)
    // ... etc for get, del, scan
)
```
Apply same pattern to:
- `infrastructure/mattermost/client.go` — mattermost_api_calls_total, mattermost_api_duration_seconds
- `infrastructure/keep/client.go` — keep_api_calls_total
- `application/usecase/handle_alert.go` — alerts_received_total (dynamic labels need `fmt.Sprintf`, keep GetOrCreate for those)
- `application/usecase/handle_callback.go` — callbacks_received_total (dynamic), alerts_updated_total (static)
- `interface/http/middleware/metrics.go`

**Note:** Counters with dynamic labels (severity, status) must stay as `GetOrCreateCounter` since label values are runtime-determined. Only pre-register counters with static labels.

### 4.3 M17 — MessageBuilder depends on concrete FileConfig

**Problem:** `messagebuilder.Builder` takes `*config.FileConfig` directly instead of an interface.

**Fix:**
- Create interface in `application/port/message_config.go`:
```go
type MessageConfig interface {
    ColorForSeverity(severity string) string
    EmojiForSeverity(severity string) string
    IsLabelExcluded(label string) bool
    IsLabelDisplayed(label string) bool
    RenameLabel(label string) string
    FooterText() string
    FooterIconURL() string
}
```
- `infrastructure/config/file_config.go`: Add `FooterText()` and `FooterIconURL()` methods (currently accessed via `Message.Footer.Text` directly)
- `infrastructure/messagebuilder/builder.go`: Change field from `*config.FileConfig` to `port.MessageConfig`
- `cmd/server/main.go`: `fileCfg` already implements all methods — pass as `port.MessageConfig`

### 4.4 H6 — Count() uses SCAN

**Problem:** `Count()` iterates entire Redis keyspace. Used only in `Repository` interface but never called in application code.

**Fix:**
- Remove `Count(ctx context.Context) (int, error)` from `domain/post/repository.go` interface
- Remove `Count` implementation from `infrastructure/valkey/post_repository.go`
- Remove `Count` from test mocks if any
- If count is needed in future — use atomic counter key (increment on Save, decrement on Delete)

### 4.5 L24 — URL-encode fingerprint in Keep UI links

**Problem:** Fingerprint value used raw in URL query parameter.

**Fix:**
- `infrastructure/messagebuilder/builder.go`: Import `net/url`, use `url.QueryEscape(a.Fingerprint().Value())` in all `titleLink` constructions (lines 28, 83, 130)

### 4.6 M9 — Label parser escape bug

**Problem:** `\\'` (escaped backslash before quote) incorrectly treated as escaped quote. `s[i-1] != '\\'` doesn't count consecutive backslashes.

**Fix:**
- `application/usecase/label_parser.go`: Replace simple `s[i-1] != '\\'` check with a function that counts consecutive backslashes before position `i`:
```go
func isEscaped(s string, pos int) bool {
    count := 0
    for i := pos - 1; i >= 0 && s[i] == '\\'; i-- {
        count++
    }
    return count%2 == 1
}
```
- Apply in `splitPairs` (line 81) and `findColon` (line 140)
- Add test case: `{'key': 'value with \\\\'}` should parse as `key` → `value with \\`

---

## Phase 5: Use Case & Handler Fixes

### 5.1 H4 — Request-scoped timeout

**Problem:** Handlers inherit server's WriteTimeout (60s) but callback can chain GetUser (30s) + EnrichAlert (30s) + UpdatePost (30s).

**Fix:**
- `interface/http/handler/webhook_handler.go`: Wrap context:
```go
ctx, cancel := context.WithTimeout(c.Request.Context(), 30*time.Second)
defer cancel()
```
- `interface/http/handler/callback_handler.go`: Same with 30s timeout
- HTTP clients already have their own 30s timeout, so the handler timeout acts as an overall cap

### 5.2 M10 — Async Keep EnrichAlert in callback

**Problem:** EnrichAlert is called synchronously, adding latency to user-facing callback response.

**Fix:**
- `application/usecase/handle_callback.go`: In `handleAcknowledge` and `handleResolve`, fire EnrichAlert in a goroutine:
```go
go func() {
    enrichCtx, enrichCancel := context.WithTimeout(context.Background(), 10*time.Second)
    defer enrichCancel()
    if err := uc.keepClient.EnrichAlert(enrichCtx, fingerprint.Value(), "acknowledged"); err != nil {
        uc.logger.Error("Failed to enrich alert in Keep",
            slog.String("fingerprint", fingerprint.Value()),
            slog.String("error", err.Error()),
        )
    }
}()
```
- This decouples Keep API latency from Mattermost callback response time

### 5.3 M18 — Error propagation in callback

**Problem:** EnrichAlert errors are logged but swallowed. Delete errors are logged but swallowed. No error metrics for Delete.

**Fix:**
- EnrichAlert is now async (M10), so error handling stays as log-only in the goroutine (acceptable for fire-and-forget)
- Delete errors in `handleResolve`: Return the error instead of swallowing. If Redis delete fails, the caller should know:
```go
if err := uc.postRepo.Delete(ctx, fingerprint); err != nil {
    return nil, fmt.Errorf("delete post from store: %w", err)
}
```
- This changes behavior: callback now returns 500 on delete failure, which is correct — the state is inconsistent

### 5.4 M15 — Demote success logs to DEBUG

**Problem:** 4+ INFO logs per alert. Under alert storms, excessive noise.

**Fix — change `Info` to `Debug` in:**
- `infrastructure/mattermost/client.go`:
  - Line 117: `CreatePost completed` → Debug
  - Line 172: `UpdatePost completed` → Debug
  - Line 229: `GetChannelByName completed` → removed (method deleted in Phase 3)
- `infrastructure/keep/client.go`:
  - Line 84: `EnrichAlert completed` → Debug
- `infrastructure/valkey/post_repository.go`: Already uses Debug — no change needed

**Keep as INFO:**
- `application/usecase/handle_alert.go`: "Alert received", "Alert posted to Mattermost", "Alert updated (re-fire)", "Alert resolved" — these are business events
- `application/usecase/handle_callback.go`: "Callback received", "Callback processed" — business events

### 5.5 L20 — parsePythonDict error signature

**Problem:** `parsePythonDict` returns `(map[string]string, error)` but never returns a non-nil error. Misleading.

**Fix:**
- `application/usecase/label_parser.go`: Change `parsePythonDict` signature to `func parsePythonDict(s string) map[string]string`
- Update caller in `ParsePythonDictRepr` (line 40)

---

## Phase 6: Router & Config Fixes

### 6.1 L23 — Port range validation

**Fix:**
- `infrastructure/config/config.go` `validate()`: Add port check:
```go
if c.Server.Port < 1 || c.Server.Port > 65535 {
    return fmt.Errorf("SERVER_PORT must be between 1 and 65535, got %d", c.Server.Port)
}
```

### 6.2 L25 — gin.SetMode global side-effect

**Problem:** `gin.SetMode(gin.ReleaseMode)` in `router.go` is a global side-effect that leaks into tests.

**Fix:**
- `interface/http/router.go`: Remove `gin.SetMode(gin.ReleaseMode)`
- `cmd/server/main.go`: Add `gin.SetMode(gin.ReleaseMode)` before calling `NewRouter`

### 6.3 L26 — Health endpoints bypass middleware

**Problem:** Health/metrics go through full middleware stack (logging, metrics) causing noise.

**Fix:**
- `interface/http/router.go`: Register health routes before middleware:
```go
router := gin.New()

// Health endpoints — no middleware
router.GET("/health/live", healthHandler.Live)
router.GET("/health/ready", healthHandler.Ready)
router.GET("/metrics", healthHandler.Metrics)

// Middleware for API routes
router.Use(middleware.Recovery(log))
router.Use(middleware.RequestID())
router.Use(middleware.BodyLimit(1 << 20))
router.Use(middleware.Metrics())
router.Use(middleware.Logging(log))

v1 := router.Group("/api/v1")
// ...
```

Wait — Gin applies `Use` middleware to all **subsequently registered** routes AND to routes already registered. We need a different approach: use a route group for API with middleware.

```go
router := gin.New()

// Health endpoints — minimal middleware (only recovery)
router.GET("/health/live", healthHandler.Live)
router.GET("/health/ready", healthHandler.Ready)
router.GET("/metrics", healthHandler.Metrics)

// API routes with full middleware
api := router.Group("/api")
api.Use(middleware.Recovery(log))
api.Use(middleware.RequestID())
api.Use(middleware.BodyLimit(1 << 20))
api.Use(middleware.Metrics())
api.Use(middleware.Logging(log))
{
    v1 := api.Group("/v1")
    v1.POST("/webhook/alert", webhookHandler.HandleAlert)
    v1.POST("/callback", callbackHandler.HandleCallback)
}
```

Actually, Gin's `Use` only applies to routes registered after the `Use` call on that engine/group. But we still want Recovery on health endpoints. Better:

```go
router := gin.New()
router.Use(middleware.Recovery(log))

// Health endpoints — only recovery
router.GET("/health/live", healthHandler.Live)
router.GET("/health/ready", healthHandler.Ready)
router.GET("/metrics", healthHandler.Metrics)

// API routes with full middleware
v1 := router.Group("/api/v1")
v1.Use(middleware.RequestID())
v1.Use(middleware.BodyLimit(1 << 20))
v1.Use(middleware.Metrics())
v1.Use(middleware.Logging(log))
{
    v1.POST("/webhook/alert", webhookHandler.HandleAlert)
    v1.POST("/callback", callbackHandler.HandleCallback)
}
```

### 6.4 L29 — Health ready reveals "valkey" backend

**Fix:**
- `interface/http/handler/health_handler.go` line 29:
```go
// Before:
c.JSON(http.StatusServiceUnavailable, gin.H{"status": "not ready", "error": "valkey"})
// After:
c.JSON(http.StatusServiceUnavailable, gin.H{"status": "not ready"})
```

---

## Files Changed (Summary)

| Phase | Files Modified | Files Created | Files Deleted |
|-------|---------------|---------------|---------------|
| 1 | `domain/alert/fingerprint.go`, `domain/post/attachment.go`, `domain/post/button.go`, `infrastructure/mattermost/client.go` | — | `domain/post/color.go` |
| 2 | `application/dto/keep_alert.go`, `application/usecase/handle_callback.go`, `interface/http/handler/callback_handler.go` | `application/dto/callback_output.go` | — |
| 3 | `infrastructure/config/config.go`, `infrastructure/config/file_config.go`, `application/port/mattermost.go`, `application/port/channel_resolver.go`, `application/usecase/handle_alert.go`, `infrastructure/mattermost/client.go`, `cmd/server/main.go` | — | — |
| 4 | `infrastructure/mattermost/client.go`, `infrastructure/keep/client.go`, `infrastructure/messagebuilder/builder.go`, `infrastructure/valkey/post_repository.go`, `domain/post/repository.go`, `application/usecase/label_parser.go` | `application/port/message_config.go` | — |
| 5 | `interface/http/handler/webhook_handler.go`, `interface/http/handler/callback_handler.go`, `application/usecase/handle_callback.go`, `infrastructure/mattermost/client.go`, `infrastructure/keep/client.go` | — | — |
| 6 | `infrastructure/config/config.go`, `interface/http/router.go`, `interface/http/handler/health_handler.go`, `cmd/server/main.go` | — | — |

## Test Impact

Every phase requires updating corresponding `_test.go` files. Key test changes:
- Phase 1: Fingerprint validation tests (new valid/invalid cases), mattermost client tests (wire types)
- Phase 2: Callback handler tests (new DTO), webhook handler tests (400 for missing fields)
- Phase 3: Handle alert tests (remove teamName, mock changes), mattermost client tests (remove channel methods), config tests
- Phase 4: Metric assertions may change, label parser tests (new escape cases), message builder tests (interface mock)
- Phase 5: Callback use case tests (async EnrichAlert, Delete error propagation), handler tests (timeout)
- Phase 6: Router tests, config tests (port validation), health handler tests
